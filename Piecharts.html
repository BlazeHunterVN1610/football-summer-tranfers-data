<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transfer Fee Pie Charts</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .chart {
            display: inline-block;
            margin: 20px;
            position: relative;
        }
        .center-text {
            text-anchor: middle;
            font-weight: bold;
        }
        #upload {
            margin: 20px;
        }
        .arc text {
            font-size: 14px; /* Increased font size */
            text-anchor: middle;
            pointer-events: none; /* Ensure text is not interactive */
        }
        .legend {
            font-size: 12px;
            position: absolute;
            top: 0;
            left: 460px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="upload">
        <input type="file" id="file2021" accept=".csv">
        <input type="file" id="file2022" accept=".csv">
        <button id="generate">Generate Charts</button>
    </div>
    <div>
        <select id="yearSelection">
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="both">2021 & 2022</option>
        </select>
    </div>
    <div class="chart" id="chart-2021-from" style="display:none;"></div>
    <div class="chart" id="chart-2021-to" style="display:none;"></div>
    <div class="chart" id="chart-2022-from" style="display:none;"></div>
    <div class="chart" id="chart-2022-to" style="display:none;"></div>
    <div class="chart" id="chart-both-from" style="display:none;"></div>
    <div class="chart" id="chart-both-to" style="display:none;"></div>
    
    <script>
        const colors = d3.scaleOrdinal()
            .domain(["England", "Spain", "Germany", "France", "Italy", "Netherlands", "Portugal"])
            .range(d3.schemeCategory10);

        const width = 450, height = 450, radius = Math.min(width, height) / 2 - 10;

        const countryToLeague = {
            "England": "Premier League",
            "Spain": "La Liga",
            "Germany": "Bundesliga",
            "France": "Ligue 1",
            "Italy": "Serie A",
            "Netherlands": "Eredivisie",
            "Portugal": "Primeira Liga"
        };

        const createPieChart = (data, elementId, title) => {
            const svg = d3.select(`#${elementId}`)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(radius * 0.4)  // Reduced inner radius
                .outerRadius(radius);

            const arcs = svg.selectAll(".arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => colors(d.data.key));

            // Add labels inside the pie chart for large slices
            arcs.filter(d => (d.data.value / d3.sum(data, d => d.value)) * 100 >= 7)
                .append("text")
                .attr("transform", d => {
                    const pos = arc.centroid(d);
                    pos[1] += 10; // Move label down
                    return `translate(${pos})`;
                })
                .attr("dy", "0.35em")
                .text(d => countryToLeague[d.data.key])
                .attr("fill", "black")
                .style("font-size", "14px")
                .style("text-anchor", "middle");

            arcs.filter(d => (d.data.value / d3.sum(data, d => d.value)) * 100 >= 7)
                .append("text")
                .attr("transform", d => {
                    const pos = arc.centroid(d);
                    pos[1] += 30; // Move percentage down further
                    return `translate(${pos})`;
                })
                .attr("dy", "0.35em")
                .text(d => {
                    const percentage = (d.data.value / d3.sum(data, d => d.value)) * 100;
                    return `${percentage.toFixed(1)}%`;
                })
                .attr("fill", "black")
                .style("font-size", "14px")
                .style("text-anchor", "middle");

            // Create legend for small slices
            const legend = d3.select(`#${elementId}`)
                .append("div")
                .attr("class", "legend");

            const smallSlices = data.filter(d => (d.value / d3.sum(data, d => d.value)) * 100 < 7);
            const legendItems = legend.selectAll(".legend-item")
                .data(smallSlices)
                .enter()
                .append("div")
                .attr("class", "legend-item");

            legendItems.append("div")
                .attr("class", "legend-color")
                .style("background-color", d => colors(d.key));

            legendItems.append("span")
                .text(d => countryToLeague[d.key]);

            legendItems.append("span")
                .text(d => {
                    const percentage = (d.value / d3.sum(data, d => d.value)) * 100;
                    return ` ${percentage.toFixed(1)}%`;
                });

            const totalValue = d3.sum(data, d => d.value).toFixed(1) + "M EUR";
            svg.append("text")
                .attr("class", "center-text")
                .attr("dy", "-1.5em")
                .text(title);

            svg.append("text")
                .attr("class", "center-text")
                .attr("dy", "0.5em")
                .text(`Total: ${totalValue}`);
        };

        const processData = (data, type) => {
            const groupedData = d3.rollup(data,
                v => d3.sum(v, d => +d["Transfer fee"]),
                d => d[type]);

            const processedData = Array.from(groupedData, ([key, value]) => ({ key, value }))
                .filter(d => ["England", "Spain", "Germany", "France", "Italy", "Netherlands", "Portugal"].includes(d.key));
            return processedData;
        };

        const drawCharts = (data2021, data2022) => {
            const data2021From = processData(data2021, "Country_from");
            const data2021To = processData(data2021, "Country_to");
            const data2022From = processData(data2022, "Country_from");
            const data2022To = processData(data2022, "Country_to");
            const dataBothFrom = processData([...data2021, ...data2022], "Country_from");
            const dataBothTo = processData([...data2021, ...data2022], "Country_to");

            createPieChart(data2021From, "chart-2021-from", "Spend 2021");
            createPieChart(data2021To, "chart-2021-to", "Income 2021");
            createPieChart(data2022From, "chart-2022-from", "Spend 2022");
            createPieChart(data2022To, "chart-2022-to", "Income 2022");
            createPieChart(dataBothFrom, "chart-both-from", "Spend 2021 & 2022");
            createPieChart(dataBothTo, "chart-both-to", "Income 2021 & 2022");
        };

        document.getElementById('generate').addEventListener('click', async () => {
            const file2021 = document.getElementById('file2021').files[0];
            const file2022 = document.getElementById('file2022').files[0];

            if (file2021 && file2022) {
                try {
                    const data2021 = await readCSV(file2021);
                    const data2022 = await readCSV(file2022);
                    drawCharts(data2021, data2022);
                    document.getElementById('yearSelection').addEventListener('change', () => {
                        const selectedYear = document.getElementById('yearSelection').value;
                        toggleCharts(selectedYear);
                    });
                    toggleCharts('2021'); // Initialize with 2021 charts
                } catch (error) {
                    console.error("Error processing files:", error);
                }
            } else {
                alert("Please upload both 2021 and 2022 CSV files.");
            }
        });

        const readCSV = file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    const data = d3.csvParse(event.target.result);
                    resolve(data);
                };
                reader.onerror = error => reject(error);
                reader.readAsText(file);
            });
        };

        const toggleCharts = (year) => {
            document.getElementById('chart-2021-from').style.display = 'none';
            document.getElementById('chart-2021-to').style.display = 'none';
            document.getElementById('chart-2022-from').style.display = 'none';
            document.getElementById('chart-2022-to').style.display = 'none';
            document.getElementById('chart-both-from').style.display = 'none';
            document.getElementById('chart-both-to').style.display = 'none';

            if (year === '2021') {
                document.getElementById('chart-2021-from').style.display = 'inline-block';
                document.getElementById('chart-2021-to').style.display = 'inline-block';
            } else if (year === '2022') {
                document.getElementById('chart-2022-from').style.display = 'inline-block';
                document.getElementById('chart-2022-to').style.display = 'inline-block';
            } else if (year === 'both') {
                document.getElementById('chart-both-from').style.display = 'inline-block';
                document.getElementById('chart-both-to').style.display = 'inline-block';
            }
        };
    </script>
</body>
</html>
